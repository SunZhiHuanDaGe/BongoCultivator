# Plan 45: 气运系统重构与实装 (Luck Overhaul)

**状态**: ✅ 已完成 (Completed)
**完成日期**: 2026-01-05

## 目标 (Objective)
重构"气运" (Affection/Luck) 系统，使其从原本模糊的"世界好感度"转变为**单次轮回有效的核心战斗属性**。
气运将在每一世轮回中起到至关重要的作用，影响修炼效率、掉落产出以及突破成功率。

## 设计理念 (Design Concepts)
1.  **单次有效 (Roguelike)**: 气运属于当前角色的"运势"，**轮回兵解时会重置为 0**（不继承）。
2.  **核心用途**:
    *   **修炼加速**: 运气好的人，修炼事半功倍。
    *   **探宝加成**: 运气好的人，走路都能捡到宝。
    *   **逆天改命**: 运气好的人，渡劫更容易成功。
3.  **获取途径**:
    *   **初始随机**: 每次出生自带随机气运波动。
    *   **本世积累**: 通过服用特殊的【气运类】丹药或天材地宝提升。
    *   **事件奇遇**: 挂机/历练中触发的机缘事件。新增一些跟气运有关的奇遇，比较稀有。

## 详细变更 (Detailed Changes)

### 1. 属性定义更新 ✅
*   **名称**: `Affection` (代码引用) -> **气运 (Luck)** (UI显示)
*   **作用域**: 当前一世 (Per Life)。
*   **重置**: 无论"主动兵解"还是"身死道消"，下一世气运均重置后随机给予 0-99 的初始气运。

### 2. 数值影响公式 ✅
| 模块 | 影响公式 | 说明 | 状态 |
| :--- | :--- | :--- | :---: |
| **修炼效率** (Exp) | `最终倍率 *= (1.0 + 气运 * 1%)` | 每点气运增加 **1%** 修练与挂机收益。 | ✅ |
| **物品掉落** (Drop) | `掉落权重 += (气运 * 0.5%)` | 增加每次心跳判定的掉落概率。 | ✅ |
| **渡劫突破** (Level Up) | `成功率 += (气运 * 0.1%)` | 微量增加突破成功率 (上限 +10%)。 | ✅ |
| **坊市品质** (Market) | `高阶率 = 10% + 气运*0.2%`<br>`折扣下限 -= 气运*0.3%` | 气运高更容易刷出高阶物品和拿到折扣。 | ✅ |

*注：气运上限建议软锁定在 100 左右，但代码层面可不设硬上限。*

### 3. 新增物品 (New Items) ✅
为了让玩家能主动提升气运，新增以下消耗品：

| ID | 名称 | 品阶 | 类型 | 效果 | 描述 | 状态 |
| :--- | :--- | :--- | :--- | :--- | :--- | :---: |
| `pill_luck_1` | **小造化丹** | 1阶 | consumable | 气运 +1 | 夺天地之造化，微量提升本世气运。 （一面之缘）| ✅ |
| `pill_luck_3` | **生生造化丹** | 3阶 | consumable | 气运 +3 | 蕴含天机之力的宝珠，服用可转运。 （一面之缘）| ✅ |
| `fruit_karma` | **春秋大道丹** | 5阶 | consumable | 气运 +5 | 蕴含时间法则的丹药，可以从时间长河中重塑气运。（一面之缘） | ✅ |
| `root_dragon` | **鸿蒙气运** | 8阶 | consumable | 气运 +10 | 神秘且强大的气息，拥有逆天改命之效。（一面之缘） | ✅ |

这些，一世只能吃一次，多了会无效。说明中标注了（一面之缘）。
这些丹药只能从市场获得，自己无法炼制。

### 4. 新增气运事件 (New Events) ✅
添加了 10 个气运相关的随机事件：

#### 正面事件 (提升气运)
| 事件名 | 权重 | 效果 | 境界限制 |
| :--- | :---: | :--- | :--- |
| **金猫送福** | 3 | 气运 +2 | 0-8 |
| **流星许愿** | 5 | 气运 +1, 修为 +50~150 | 1-8 |
| **七彩祥云** | 2 | 气运 +3, 灵石 +500~1000 | 2-8 |
| **仙人抚顶** | 1 | 气运 +5, 心魔 -10 (唯一) | 3-8 |
| **锦鲤附体** | 4 | 气运 +2 | 0-5 |

#### 负面事件 (降低气运)
| 事件名 | 权重 | 效果 | 境界限制 |
| :--- | :---: | :--- | :--- |
| **黑猫横路** | 4 | 气运 -1 | 0-8 |
| **碎镜之兆** | 3 | 气运 -2, 心魔 +3 | 1-8 |
| **因果反噬** | 2 | 气运 -3, 修为 -50~100 | 2-8 |

#### 选择类事件 (赌运气)
| 事件名 | 权重 | 描述 | 境界限制 |
| :--- | :---: | :--- | :--- |
| **天命赌局** | 5 | 50%概率: 赢 气运+3 / 输 气运-2 | 1-6 |
| **许愿古井** | 6 | 投入100灵石，60%概率: 气运+2 / 气运-1 | 0-8 |

### 5. 代码实现计划 ✅
1.  **Item Data**: ✅ 在数据库/JSON中添加上述新物品 (`tools/update_luck_pills.py`)
2.  **Cultivator Logic**:
    *   ✅ 更新 `update()` 方法，应用气运对 `base_exp` 的乘区加成（每点 +1%）
    *   ✅ 更新 `update()` 方法，应用气运对掉落概率的加成（每点 +0.5%）
    *   ✅ 更新 `attempt_breakthrough()` 方法，加入气运对渡劫成功率的加成（每点 +0.1%，上限 +10%）
    *   ✅ 更新 `refresh_market()` 方法，加入气运对高阶物品和折扣的影响
3.  **轮回逻辑**: ✅ 更新 `ReincarnationManager.perform_reincarnation()`:
    *   轮回后随机给予 0-99 的初始气运
    *   清空"一面之缘"使用记录
4.  **"一面之缘"机制**: ✅ 
    *   添加 `UsedOnceItem` 模型表记录使用状态
    *   `Cultivator` 新增 `used_once_items` 集合
    *   `inventory_window.py` 检测并阻止重复使用
5.  **UI Update**: ✅ 确保 Item Detail Window 能正确解析并显示气运效果和"一面之缘"标记
6.  **事件系统**: ✅ 
    *   `EventEngine._apply_effects()` 支持 `affection` 效果
    *   添加 10 个气运相关事件到数据库 (`tools/update_luck_events.py`)

## 修改的文件
- `src/services/reincarnation_manager.py` - 轮回时随机初始气运
- `src/cultivator.py` - 气运加成逻辑（修炼/掉落/渡劫/坊市）
- `src/models/player.py` - 新增 `UsedOnceItem` 模型
- `src/models/__init__.py` - 导出新模型
- `src/inventory_window.py` - "一面之缘"使用检查
- `src/item_manager.py` - 气运效果显示、分类修复
- `src/services/event_engine.py` - 支持气运效果
- `src/data/items_v2.json` - 新增气运丹药
- `src/data/items.json` - 同步更新
- `tools/update_luck_pills.py` - 丹药数据更新工具
- `tools/update_luck_events.py` - 事件数据更新工具

## 预期体验
玩家在每一世开始时，会关注如何快速获得【造化丹】。
*   **低气运策略**: 苟着发育，尽量不挑战低概率突破，或者尽早兵解重开。
*   **高气运策略**: 疯狂挂机刷怪（高掉落+高经验），冲击极限境界。

## 气运加成汇总
| 气运值 | 修炼加成 | 掉落加成 | 渡劫加成 | 高阶物品率 | 最低折扣 |
| :---: | :---: | :---: | :---: | :---: | :---: |
| 0 | +0% | +0% | +0% | 10% | 80% |
| 50 | +50% | +25% | +5% | 20% | 65% |
| 100 | +100% | +50% | +10% | 30% | 50% |
